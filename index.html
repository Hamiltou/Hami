<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قنوات البث المباشر</title>
    <style>
        /* أنماط التحميل */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196f3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .channel-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .video-player {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <h1>إدارة القنوات</h1>
        
        <!-- نموذج إنشاء القناة -->
        <div class="create-channel">
            <input type="text" id="channelName" placeholder="اسم القناة">
            <input type="number" id="maxVideos" min="1" value="5">
            <button onclick="app.createChannel()">إنشاء</button>
        </div>

        <!-- قائمة القنوات -->
        <div id="channelsList" class="channels-grid"></div>

        <!-- مشغل الفيديو -->
        <div id="playerSection" style="display:none;">
            <video id="mainVideo" class="video-player" controls></video>
            <button onclick="app.stopPlayback()">إيقاف</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot,
            addDoc, updateDoc, doc, deleteDoc, serverTimestamp,
            arrayUnion, increment 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytesResumable, 
            getDownloadURL, deleteObject, listAll 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        class VideoApp {
            constructor() {
                this.firebaseConfig = {
                    apiKey: "AIzaSyB3...",
                    authDomain: "your-project.firebaseapp.com",
                    projectId: "your-project",
                    storageBucket: "your-project.appspot.com",
                    messagingSenderId: "123456789",
                    appId: "1:123456789:web:abcdef1234567890"
                };
                
                this.config = {
                    maxFileSize: 100 * 1024 * 1024 // 100MB
                };

                this.state = {
                    channels: new Map(),
                    currentPlaylist: [],
                    currentVideoIndex: 0
                };
                
                this.init();
            }

            async init() {
                try {
                    this.initializeFirebase();
                    this.cacheElements();
                    await this.setupRealtimeUpdates();
                } catch (error) {
                    this.handleError('تهيئة التطبيق', error);
                }
            }

            initializeFirebase() {
                this.app = initializeApp(this.firebaseConfig);
                this.db = getFirestore(this.app);
                this.storage = getStorage(this.app);
            }

            cacheElements() {
                this.elements = {
                    channelsList: document.getElementById('channelsList'),
                    mainVideo: document.getElementById('mainVideo'),
                    playerSection: document.getElementById('playerSection'),
                    channelName: document.getElementById('channelName'),
                    maxVideos: document.getElementById('maxVideos')
                };
            }

            async setupRealtimeUpdates() {
                const channelsRef = collection(this.db, 'channels');
                
                this.unsubscribe = onSnapshot(channelsRef, snapshot => {
                    snapshot.docChanges().forEach(change => {
                        const channelData = change.doc.data();
                        const channel = {
                            id: change.doc.id,
                            name: channelData.name,
                            maxVideos: channelData.maxVideos,
                            videoUrls: channelData.videoUrls || [],
                            createdAt: channelData.createdAt?.toDate()
                        };

                        switch (change.type) {
                            case 'added':
                            case 'modified':
                                this.state.channels.set(channel.id, channel);
                                this.renderChannel(channel);
                                break;
                            case 'removed':
                                this.state.channels.delete(channel.id);
                                this.removeChannelElement(channel.id);
                                break;
                        }
                    });
                });
            }

            renderChannel(channel) {
                let channelElement = document.querySelector(`[data-channel-id="${channel.id}"]`);
                
                if (!channelElement) {
                    channelElement = document.createElement('div');
                    channelElement.className = 'channel-card';
                    channelElement.dataset.channelId = channel.id;
                    this.elements.channelsList.prepend(channelElement);
                }

                channelElement.innerHTML = `
                    <h3>${this.sanitizeHTML(channel.name)}</h3>
                    <p>عدد الفيديوهات: ${channel.videoUrls.length}/${channel.maxVideos}</p>
                    <div class="channel-actions">
                        <button class="play-btn" data-id="${channel.id}">
                            ${channel.videoUrls.length ? 'تشغيل' : 'غير متاح'}
                        </button>
                        <button class="upload-btn" data-id="${channel.id}" 
                            ${channel.videoUrls.length >= channel.maxVideos ? 'disabled' : ''}>
                            رفع فيديو
                        </button>
                        <button class="delete-btn" data-id="${channel.id}">حذف</button>
                    </div>
                `;

                channelElement.querySelector('.play-btn').addEventListener('click', () => 
                    this.playChannel(channel.id)
                );
                channelElement.querySelector('.upload-btn').addEventListener('click', () => 
                    this.uploadVideo(channel.id)
                );
                channelElement.querySelector('.delete-btn').addEventListener('click', () => 
                    this.deleteChannel(channel.id)
                );
            }

            async createChannel() {
                const name = this.elements.channelName.value.trim();
                const maxVideos = parseInt(this.elements.maxVideos.value);

                if (!name || isNaN(maxVideos)) {
                    return this.showToast('البيانات غير صحيحة', 'error');
                }

                try {
                    this.toggleLoading(true);
                    
                    const newChannel = {
                        name,
                        maxVideos,
                        videoUrls: [],
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(this.db, 'channels'), newChannel);
                    this.elements.channelName.value = '';
                    this.showToast('تم إنشاء القناة بنجاح', 'success');
                } catch (error) {
                    this.handleError('إنشاء القناة', error);
                } finally {
                    this.toggleLoading(false);
                }
            }

            async playChannel(channelId) {
                try {
                    const channel = this.state.channels.get(channelId);
                    if (!channel || channel.videoUrls.length === 0) {
                        return this.showToast('لا يوجد فيديوهات متاحة', 'warning');
                    }

                    this.state.currentPlaylist = channel.videoUrls;
                    this.state.currentVideoIndex = 0;
                    
                    this.togglePlayerUI(true);
                    this.playNextVideo(0);
                    
                    this.startViewTimeTracking(channelId);
                } catch (error) {
                    this.handleError('تشغيل القناة', error);
                }
            }

            togglePlayerUI(show) {
                this.elements.playerSection.style.display = show ? 'block' : 'none';
                this.elements.channelsList.style.display = show ? 'none' : 'grid';
            }

            playNextVideo(index) {
                if (index >= this.state.currentPlaylist.length) {
                    return this.stopPlayback();
                }

                this.state.currentVideoIndex = index;
                const videoUrl = this.state.currentPlaylist[index];
                
                if (index < this.state.currentPlaylist.length - 1) {
                    const nextVideo = document.createElement('video');
                    nextVideo.src = this.state.currentPlaylist[index + 1];
                    nextVideo.preload = 'auto';
                }

                this.elements.mainVideo.src = videoUrl;
                this.elements.mainVideo.play()
                    .then(() => {
                        this.elements.mainVideo.controls = true;
                    })
                    .catch(error => {
                        this.showToast('حدث خطأ في تشغيل الفيديو', 'error');
                        console.error('Video play error:', error);
                        this.playNextVideo(index + 1);
                    });
            }

            startViewTimeTracking(channelId) {
                this.viewStartTime = Date.now();
                this.viewInterval = setInterval(() => {
                    const duration = Math.floor((Date.now() - this.viewStartTime) / 1000);
                    this.updateViewDuration(channelId, duration);
                }, 30000);
            }

            async updateViewDuration(channelId, duration) {
                try {
                    await updateDoc(doc(this.db, 'channels', channelId), {
                        totalViewTime: increment(duration)
                    });
                } catch (error) {
                    console.error('Error updating view time:', error);
                }
            }

            stopPlayback() {
                clearInterval(this.viewInterval);
                this.elements.mainVideo.pause();
                this.elements.mainVideo.src = '';
                this.togglePlayerUI(false);
            }

            async uploadVideo(channelId) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'video/mp4,video/webm';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (file.size > this.config.maxFileSize) {
                        return this.showToast('حجم الملف يتجاوز 100MB', 'error');
                    }

                    try {
                        this.toggleLoading(true);
                        
                        const timestamp = Date.now();
                        const storageRef = ref(this.storage, 
                            `channels/${channelId}/${timestamp}_${file.name}`);
                        
                        const uploadTask = uploadBytesResumable(storageRef, file);
                        
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = 
                                    (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                this.updateUploadProgress(channelId, progress);
                            },
                            (error) => {
                                throw error;
                            }
                        );

                        await uploadTask;
                        const url = await getDownloadURL(storageRef);
                        
                        await updateDoc(doc(this.db, 'channels', channelId), {
                            videoUrls: arrayUnion(url)
                        });

                        this.showToast('تم الرفع بنجاح', 'success');
                    } catch (error) {
                        this.handleError('رفع الفيديو', error);
                    } finally {
                        this.toggleLoading(false);
                        this.removeUploadProgress(channelId);
                    }
                };
                input.click();
            }

            updateUploadProgress(channelId, progress) {
                const channelElement = document.querySelector(`[data-channel-id="${channelId}"]`);
                if (!channelElement) return;

                let progressBar = channelElement.querySelector('.upload-progress');
                if (!progressBar) {
                    progressBar = document.createElement('div');
                    progressBar.className = 'upload-progress';
                    channelElement.querySelector('.channel-actions').prepend(progressBar);
                }
                
                progressBar.innerHTML = `
                    <div class="progress-bar" style="width: ${progress}%">
                        ${Math.round(progress)}%
                    </div>
                `;
            }

            removeUploadProgress(channelId) {
                const channelElement = document.querySelector(`[data-channel-id="${channelId}"]`);
                if (channelElement) {
                    const progressBar = channelElement.querySelector('.upload-progress');
                    if (progressBar) progressBar.remove();
                }
            }

            async deleteChannel(channelId) {
                if (!confirm('هل أنت متأكد من حذف القناة؟ سيتم حذف جميع الفيديوهات المرتبطة.')) {
                    return;
                }

                try {
                    this.toggleLoading(true);
                    
                    const storageRef = ref(this.storage, `channels/${channelId}`);
                    const files = await listAll(storageRef);
                    await Promise.all(files.items.map(fileRef => deleteObject(fileRef)));
                    
                    await deleteDoc(doc(this.db, 'channels', channelId));
                    
                    this.showToast('تم الحذف بنجاح', 'success');
                } catch (error) {
                    this.handleError('حذف القناة', error);
                } finally {
                    this.toggleLoading(false);
                }
            }

            sanitizeHTML(str) {
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            }

            toggleLoading(show) {
                document.getElementById('loading').style.display = show ? 'flex' : 'none';
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <span class="toast-message">${this.sanitizeHTML(message)}</span>
                    <button class="toast-close">&times;</button>
                `;
                
                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.remove();
                });
                
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }

            handleError(context, error) {
                console.error(`[${context}] Error:`, error);
                const message = this.getErrorMessage(error.code);
                this.showToast(`${message} (${context})`, 'error');
            }

            getErrorMessage(code) {
                const errors = {
                    'storage/unauthorized': 'ليس لديك الصلاحية',
                    'storage/retry-limit-exceeded': 'فشل المحاولة، حاول لاحقاً',
                    'permission-denied': 'تم الرفض، تحقق من الصلاحيات',
                    'default': 'حدث خطأ غير متوقع'
                };
                return errors[code] || errors.default;
            }
        }

        const app = new VideoApp();
        window.app = app;
    </script>
</body>
</html>

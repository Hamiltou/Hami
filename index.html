<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شريط بحث متقدم</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --danger-color: #dc2626;
            --text-color: #1f2937;
            --bg-color: #f3f4f6;
        }

        .search-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #cbd5e1;
            border-radius: 2rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: #fff;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .search-button {
            padding: 1rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-button:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .search-results {
            margin: 2rem auto;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .search-item {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .search-item:hover {
            background: var(--bg-color);
        }

        .highlight {
            background: #ffec99;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
        }

        .no-results {
            text-align: center;
            padding: 2rem;
            color: var(--danger-color);
            font-size: 1.2rem;
        }

        .search-stats {
            text-align: center;
            color: #64748b;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <form id="searchForm">
            <div class="search-group">
                <input 
                    type="search" 
                    id="searchInput"
                    class="search-input"
                    placeholder="ابحث هنا..."
                    aria-label="بحث"
                    autocomplete="off"
                >
                <button 
                    type="submit"
                    class="search-button"
                >
                    بحث
                </button>
            </div>
        </form>

        <div id="searchResults" class="search-results">
            <div class="search-stats" id="searchStats"></div>
            <div class="search-item">نتيجة بحث 1</div>
            <div class="search-item">نتيجة بحث 2</div>
            <div class="search-item">نتيجة بحث 3</div>
            <p id="resultsMessage" class="no-results"></p>
        </div>
    </div>
<script>class AdvancedSearch {
    constructor() {
        this._initProperties();
        this._setupObservers();
        this._registerServiceWorker();
        this._addKeyboardShortcuts();
        this.init();
    }

    _initProperties() {
        this.searchForm = document.getElementById('searchForm');
        this.searchInput = document.getElementById('searchInput');
        this.searchResults = document.getElementById('searchResults');
        this.resultsMessage = document.getElementById('resultsMessage');
        this.searchStats = document.getElementById('searchStats');
        this.items = Array.from(document.querySelectorAll('.search-item'));
        this.debounceTimeout = null;
        this.cache = new Map();
        this.worker = this._createWorker();
        this.lastSearchTerm = '';
        this.keyboardHandler = this._handleKeyboard.bind(this);
        this.sessionId = this._generateSessionId();
        this.analyticsQueue = [];
        this.performanceMetrics = {
            searchStart: 0,
            searchEnd: 0
        };
    }

    _setupObservers() {
        this.intersectionObserver = new IntersectionObserver(
            this._handleLazyLoad.bind(this),
            { rootMargin: '200px' }
        );
        
        this.mutationObserver = new MutationObserver(
            this._handleDOMChanges.bind(this)
        );
    }

    _createWorker() {
        if (window.Worker) {
            const worker = new Worker('search.worker.js');
            worker.onmessage = this._handleWorkerMessage.bind(this);
            return worker;
        }
        return null;
    }

    _generateSessionId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }

    init() {
        this._setupEventListeners();
        this._initializeItems();
        this._trackPerformance();
        this._setupAnalyticsFlush();
        this._loadPreferences();
        this._setupErrorHandling();
    }

    _setupEventListeners() {
        const eventMap = [
            [this.searchForm, 'submit', this.handleSubmit.bind(this)],
            [this.searchInput, 'input', this.handleInput.bind(this)],
            [window, 'load', this.handlePageLoad.bind(this)],
            [window, 'beforeunload', this._flushAnalytics.bind(this)],
            [document, 'keydown', this.keyboardHandler]
        ];

        eventMap.forEach(([target, event, handler]) => {
            target.addEventListener(event, handler);
        });
    }

    handleSubmit(e) {
        e.preventDefault();
        this._trackEvent('search/submit');
        this.performanceMetrics.searchStart = performance.now();
        this.performSearch();
    }

    handleInput() {
        this._trackEvent('search/input');
        clearTimeout(this.debounceTimeout);
        this.debounceTimeout = setTimeout(() => {
            this.performSearch();
            this._adjustInputWidth();
        }, this._calculateDebounceTime());
    }

    _calculateDebounceTime() {
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        return isMobile ? 500 : 300;
    }

    _adjustInputWidth() {
        const tempSpan = document.createElement('span');
        tempSpan.textContent = this.searchInput.value || this.searchInput.placeholder;
        Object.assign(tempSpan.style, {
            position: 'absolute',
            visibility: 'hidden',
            whiteSpace: 'pre'
        });
        document.body.appendChild(tempSpan);
        const width = tempSpan.offsetWidth + 20;
        this.searchInput.style.width = `${Math.min(width, 800)}px`;
        tempSpan.remove();
    }

    async performSearch() {
        try {
            const searchTerm = this.normalizeText(this.searchInput.value.trim());
            
            if (this._shouldUseCache(searchTerm)) {
                return this._applyCachedResults(searchTerm);
            }

            if (this.worker) {
                this.worker.postMessage({
                    type: 'SEARCH',
                    items: this.items.map(item => ({
                        id: item.id,
                        content: item.dataset.originalContent
                    })),
                    searchTerm
                });
            } else {
                this._processSearchLocally(searchTerm);
            }

            this._prefetchRelatedContent(searchTerm);
            this._updateSearchHistory(searchTerm);
            this._saveSearchState(searchTerm);
            this._trackSearchMetrics(searchTerm);
        } catch (error) {
            this._handleError(error);
        }
    }

    _processSearchLocally(searchTerm) {
        const results = this.items.map(item => {
            const originalContent = this.normalizeText(item.dataset.originalContent);
            const hasMatch = this.checkMatch(originalContent, searchTerm);
            return { id: item.id, hasMatch };
        });

        this._applySearchResults(results, searchTerm);
    }

    _handleWorkerMessage(event) {
        if (event.data.type === 'SEARCH_RESULTS') {
            this._applySearchResults(event.data.results, event.data.searchTerm);
        }
    }

    _applySearchResults(results, searchTerm) {
        let matchCount = 0;
        const startTime = performance.now();

        results.forEach((result, index) => {
            const item = this.items[index];
            item.style.display = result.hasMatch ? 'block' : 'none';
            
            if (result.hasMatch) {
                matchCount++;
                item.innerHTML = this.highlightMatches(
                    item.dataset.originalContent, 
                    searchTerm
                );
                this._animateItemAppearance(item);
            }
        });

        this._updateUIComponents(matchCount);
        this.cache.set(searchTerm, results);
        this.performanceMetrics.searchEnd = performance.now();
        
        this._reportPerformanceMetrics({
            searchTerm,
            duration: this.performanceMetrics.searchEnd - this.performanceMetrics.searchStart,
            resultCount: matchCount
        });
    }

    _animateItemAppearance(item) {
        item.animate([
            { opacity: 0, transform: 'translateY(20px)' },
            { opacity: 1, transform: 'translateY(0)' }
        ], {
            duration: 300,
            easing: 'cubic-bezier(0.4, 0, 0.2, 1)'
        });
    }

    _updateUIComponents(matchCount) {
        this.updateResultsMessage(matchCount > 0);
        this.updateSearchStats(matchCount);
        this._updateAriaLive(matchCount);
    }

    _updateAriaLive(matchCount) {
        const ariaMessage = matchCount > 0 ?
            `تم العثور على ${matchCount} نتيجة` :
            'لم يتم العثور على نتائج';
        this.searchResults.setAttribute('aria-live', 'polite');
        this.searchResults.setAttribute('aria-atomic', 'true');
        this.searchResults.textContent = ariaMessage;
    }

    _shouldUseCache(searchTerm) {
        return this.cache.has(searchTerm) && 
               this.lastSearchTerm.startsWith(searchTerm);
    }

    _applyCachedResults(searchTerm) {
        const cachedResults = this.cache.get(searchTerm);
        this._applySearchResults(cachedResults, searchTerm);
    }

    _prefetchRelatedContent(searchTerm) {
        if (searchTerm.length > 3) {
            fetch(`/api/prefetch?term=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => this._handlePrefetchData(data))
                .catch(error => console.error('Prefetch error:', error));
        }
    }

    _handlePrefetchData(data) {
        if (data.suggestions) {
            this._showSuggestions(data.suggestions);
        }
    }

    _showSuggestions(suggestions) {
        // Implementation for showing search suggestions
    }

    _trackSearchMetrics(searchTerm) {
        this.analyticsQueue.push({
            type: 'search',
            term: searchTerm,
            timestamp: Date.now(),
            sessionId: this.sessionId
        });
    }

    _setupAnalyticsFlush() {
        setInterval(() => this._flushAnalytics(), 10000);
    }

    _flushAnalytics() {
        if (this.analyticsQueue.length > 0) {
            navigator.sendBeacon('/analytics', JSON.stringify(this.analyticsQueue));
            this.analyticsQueue = [];
        }
    }

    _trackEvent(eventName) {
        this.analyticsQueue.push({
            type: 'event',
            name: eventName,
            timestamp: Date.now(),
            sessionId: this.sessionId
        });
    }

    _handleLazyLoad(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const item = entry.target;
                item.querySelector('img')?.setAttribute('src', item.dataset.src);
                this.intersectionObserver.unobserve(item);
            }
        });
    }

    _handleDOMChanges(mutations) {
        mutations.forEach(mutation => {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(node => {
                    if (node.classList?.contains('search-item')) {
                        this.items.push(node);
                        this.intersectionObserver.observe(node);
                    }
                });
            }
        });
    }

    _handleKeyboard(e) {
        if (e.ctrlKey && e.key === 'k') {
            e.preventDefault();
            this.searchInput.focus();
        }
    }

    _setupErrorHandling() {
        window.onerror = (message, source, lineno, colno, error) => {
            this._trackEvent('error', {
                message,
                source,
                line: lineno,
                column: colno,
                error: error?.stack
            });
        };

        window.addEventListener('unhandledrejection', event => {
            this._trackEvent('error', {
                type: 'unhandledrejection',
                reason: event.reason
            });
        });
    }

    _trackEvent(type, data) {
        this.analyticsQueue.push({
            type: 'error',
            errorData: data,
            timestamp: Date.now(),
            sessionId: this.sessionId
        });
    }

    _reportPerformanceMetrics(metrics) {
        if (navigator.connection?.effectiveType === '4g') {
            const perfData = {
                ...metrics,
                deviceMemory: navigator.deviceMemory || 'unknown',
                connection: navigator.connection.effectiveType,
                timestamp: Date.now()
            };
            navigator.sendBeacon('/perf-metrics', JSON.stringify(perfData));
        }
    }

    _updateSearchHistory(term) {
        if (term && term !== this.lastSearchTerm) {
            window.history.replaceState({
                ...window.history.state,
                searchHistory: [...(window.history.state?.searchHistory || []), term]
            }, '');
        }
        this.lastSearchTerm = term;
    }

    _saveSearchState(term) {
        const state = { 
            ...window.history.state,
            searchTerm: term,
            timestamp: Date.now()
        };
        history.replaceState(state, '', window.location);
    }

    _loadPreferences() {
        const prefs = localStorage.getItem('searchPreferences');
        if (prefs) {
            try {
                const { darkMode, fontSize } = JSON.parse(prefs);
                this._applyPreferences({ darkMode, fontSize });
            } catch (e) {
                console.error('Failed to load preferences:', e);
            }
        }
    }

    _applyPreferences({ darkMode, fontSize }) {
        if (darkMode) {
            document.documentElement.classList.add('dark-mode');
        }
        if (fontSize) {
            document.documentElement.style.fontSize = `${fontSize}px`;
        }
    }

    // Rest of the existing methods with minor optimizations...
}

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('ServiceWorker registration successful');
            })
            .catch(err => {
                console.error('ServiceWorker registration failed:', err);
            });
    });
}

// Initialize with performance monitoring
document.addEventListener('DOMContentLoaded', () => {
    const loadStart = performance.now();
    const search = new AdvancedSearch();
    search.restoreSearchState();
    
    window.addEventListener('load', () => {
        const loadTime = performance.now() - loadStart;
        const perfData = {
            type: 'load',
            duration: loadTime,
            timestamp: Date.now()
        };
        navigator.sendBeacon('/perf-metrics', JSON.stringify(perfData));
    });
});

</script>
</body>
</html>
